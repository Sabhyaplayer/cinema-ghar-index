<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaka Player - Video Player</title>

    <!-- Shaka Player UI CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.4/controls.min.css" integrity="sha512-AT0br9jZMA06F1Nf6jQ0YDj6EP9v8bF4/8cZ0MRUQlG+8Fkx376q/rcaENPXMWuG3hYy0fF4jPZrcW/pC27JcQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Shaka Player library -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.js" integrity="sha512-6oPQBmvNAjmYA+xOFjYILirwHBtcgkBchI6lQyL1C850L67/04N+3QLVwFwY0zNVHqzhTzqi8rQSFhDmTfUbIQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        #videoContainer {
            width: 100%;
            margin-top: 15px;
            background-color: #000; /* Black background for video area */
        }
        #videoElement {
            width: 100%;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .input-group input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-group button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-group button:hover {
            background-color: #0056b3;
        }
        .controls-group {
            margin-top: 15px;
        }
        .controls-group label {
            margin-right: 5px;
            font-weight: bold;
        }
        .controls-group select {
            padding: 5px;
            border-radius: 4px;
        }
        #status {
            margin-top: 10px;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Shaka Player Video Player</h1>

        <div class="input-group">
            <input type="text" id="videoUrlInput" placeholder="Enter Video URL (DASH or HLS)">
            <button id="loadButton">Load Video</button>
        </div>

        <div class="controls-group">
            <label for="audioTracksSelect">Audio Track:</label>
            <select id="audioTracksSelect" disabled>
                <option value="">-- Select Audio --</option>
            </select>
        </div>

        <div id="status"></div>

        <!-- Shaka Player needs a container and a video element -->
        <div id="videoContainer" data-shaka-player-container data-shaka-player-cast-receiver-id="YOUR_CAST_RECEIVER_APP_ID_HERE">
            <video id="videoElement"
                   poster="//shaka-player-demo.appspot.com/assets/poster.jpg"
                   data-shaka-player
                   ></video>
                   <!-- Note: 'controls' attribute is often managed by the UI library -->
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const videoContainer = document.getElementById('videoContainer');
        const videoUrlInput = document.getElementById('videoUrlInput');
        const loadButton = document.getElementById('loadButton');
        const audioTracksSelect = document.getElementById('audioTracksSelect');
        const statusDiv = document.getElementById('status');

        let player = null;
        let ui = null;

        function initApp() {
            statusDiv.textContent = ''; // Clear status on init
            // Install built-in polyfills to patch browser incompatibilities.
            shaka.polyfill.installAll();

            // Check to see if the browser supports the basic APIs Shaka needs.
            if (!shaka.Player.isBrowserSupported()) {
                showError('Browser not supported!');
                console.error('Browser not supported!');
                return;
            }

            // Initialize the Shaka Player instance
            player = new shaka.Player(videoElement);

            // Configure the Shaka Player UI
            ui = new shaka.ui.Overlay(player, videoContainer, videoElement);

            // Configure UI elements (optional, includes built-in audio selector)
            // You might see two audio selectors (one built-in, one custom)
            const config = {
                 'controlPanelElements': [
                    'play_pause', 'time_and_duration', 'spacer',
                    'volume', 'mute', 'fullscreen', 'overflow_menu'
                 ],
                 'overflowMenuButtons': [
                     'cast', 'quality', 'language', 'picture_in_picture', 'playback_rate'
                 ],
                 // Example: Add the built-in audio language selector to the main controls
                 // 'controlPanelElements': ['play_pause', 'time_and_duration', 'audio_language', 'spacer', 'volume', 'mute', 'fullscreen'],
            };
            ui.configure(config);


            // Add error listener
            player.addEventListener('error', onErrorEvent);
            // Add listener for track changes to update our custom dropdown
            player.addEventListener('trackschanged', onTracksChanged);

            // Add listener for the load button
            loadButton.addEventListener('click', loadVideo);

            // Add listener for the custom audio track dropdown
            audioTracksSelect.addEventListener('change', changeAudioTrack);

            console.log('Shaka Player initialized.');
        }

        function loadVideo() {
            const url = videoUrlInput.value.trim();
            if (!url) {
                showError("Please enter a video URL.");
                return;
            }
            statusDiv.textContent = 'Loading...';
            resetAudioSelector();

            // Try to load the manifest.
            player.load(url)
                .then(() => {
                    console.log(`Video loaded successfully: ${url}`);
                    statusDiv.textContent = ''; // Clear status on success
                    // `onTracksChanged` will be called automatically after load
                })
                .catch(onError); // onError needs to be defined below.
        }

        function onTracksChanged() {
            console.log('Tracks changed event triggered.');
            populateAudioSelector();
        }

        function populateAudioSelector() {
            resetAudioSelector(); // Clear previous options

            if (!player) return;

            // Get available audio languages and roles
            const audioLanguagesAndRoles = player.getAudioLanguagesAndRoles();
            console.log('Available audio languages/roles:', audioLanguagesAndRoles);

            if (audioLanguagesAndRoles.length <= 1) {
                audioTracksSelect.disabled = true; // Disable if 0 or 1 track
                return;
            }

            const activeAudioTrack = player.getVariantTracks().find(track => track.active && track.type === 'audio');
            const currentLang = activeAudioTrack ? activeAudioTrack.language : player.getConfiguration().preferredAudioLanguage; // Get current language

            audioLanguagesAndRoles.forEach(langRole => {
                const option = document.createElement('option');
                option.value = langRole.language;
                // Create a user-friendly label (e.g., "English (main)", "Spanish")
                option.textContent = `${shaka.ui.LanguageUtils.getLanguageName(langRole.language)}` + (langRole.role ? ` (${langRole.role})` : '');
                option.selected = (langRole.language === currentLang); // Select the currently active one
                audioTracksSelect.appendChild(option);
            });

            audioTracksSelect.disabled = false;
        }

        function changeAudioTrack() {
            if (!player) return;

            const selectedLanguage = audioTracksSelect.value;
            if (selectedLanguage) {
                console.log(`Changing audio language to: ${selectedLanguage}`);
                player.selectAudioLanguage(selectedLanguage);
                // Note: If roles are important, you might need more complex logic using selectVariantsByAudioRole
            }
        }

        function resetAudioSelector() {
             // Clear existing options except the placeholder
            while (audioTracksSelect.options.length > 1) {
                audioTracksSelect.remove(1);
            }
            audioTracksSelect.selectedIndex = 0; // Reset to placeholder
            audioTracksSelect.disabled = true;
        }

        // Error handling functions
        function onErrorEvent(event) {
            // Extract the shaka.util.Error object from the event.
            onError(event.detail);
        }

        function onError(error) {
            // Log the error.
            console.error('Shaka Player Error:', error.code, 'Object', error);
            showError(`Error: ${error.message} (Code: ${error.code})`);
            resetAudioSelector(); // Reset dropdown on error
        }

        function showError(message) {
            statusDiv.textContent = message;
        }

        // Wait for the DOM to load and Shaka Player UI to be ready
        document.addEventListener('shaka-ui-loaded', initApp);
        // Fallback if shaka-ui-loaded isn't fired (e.g., deferred script)
        // document.addEventListener('DOMContentLoaded', initApp); // Use this if 'shaka-ui-loaded' doesn't work reliably

    </script>

</body>
</html>
